---
layout: ru_post
title: Динамические тени (Unity, mobile)
---

На днях мы успешно завершили работу над реалтаймовыми тенями, оптимизированными под мобильные устройства. Мы решили поделиться с читателями как результатом, так и процессом работы над этой фичей.

![Alt text](http://i.imgur.com/3wQUWZS.jpg)

<iframe width="560" height="315" src="https://www.youtube.com/embed/TYAD1xqwf48" frameborder="0" allowfullscreen></iframe>

Для интересующихся наш программист поделился процессом работы над тенями:

Используется реализация реалтаймовых теней по простому принципу Texture Mapping. В отличие от каноничного и привычного Shadow Mapping, где ключевую роль играет рендер буфера глубины и попиксельный рассчёт затенённых участков, в нашем случае используется простой рендер теней (заданного цвета) на белом фоне без Z проверки и простое наложение полученной текстуры на объекты, принимающие тень. 

Для размытия используется принцип Пуассона с восемью тап-точками (сами координаты тап точек рассчитываются в вертексном шейдере для уменьшения dependent texture reads). По проведённым опытам можно отметить, что ради производительности количество точек можно уменьшить до четырёх. В оригинальном решении из статьи про Dungeon Siege II (описанном в ShaderX3) использовалось 12 точек. По умолчанию размытие отсутствует и включается через настройки игры, в случае если девайс сможет переварить эти рассчёты (девайсы с небольшим разрешением и меньшей мощностью справляются лучше, чем девайсы с UHD разрешением). 

Смешивание динамических теней с запечёнными тенями от лайтмапов работает по принципу простого отсечения нормированных значений яркости, попадая в которые динамическая тень перестаёт рисоваться. То есть задаётся диапазон яркости лайтмапа, верхняя граница которого полностью принимает тень, а нижняя полностью “отторгает”. 

Большую часть параметров рассчёта формулы нормированного значения можно рассчитать заранее, поэтому такой способ работает быстрее и выглядит лучше, чем использование ветвлений в шейдере или отсечение по конкретному значению яркости (поскольку в случае с диапазоном яркостей остаётся немного места для линейной интерполяции, которая выглядит более приятно, чем резкий переход).